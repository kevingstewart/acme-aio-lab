### ACMEv2 All-in-One Testing Lab for DNS-01 Proof Validation
All ACME proof validations must prove ownership of *something*. For the **dns-01** challenge, the client must prove:

- Ownership and control of the DNS domain

That is, the client must simply be able to control the DNS records for the requested domain. The following description of the protocol exchange is super-simplistic for the sake of illustrating the dns-01 proof requirement, and assumes things like client registration are complete. A more detailed protocol exchange is included further down in this document. Also for the sake of this document, the term "ACME provider", or simply "provider" is used to indicate an ACME service (ex. Let Encrypt).

- An ACME client sends a request to an ACME provider to "order" a new certificate (ex. www.example.com).
- The ACME provider sends back a list of supported proof validation options, typically http-01, dns-01, and tls-alpn-01, and the client indicates that it wants to use dns-01.
- The provider then sends a validation token (ex. 4FirTtbveHPsRiDRxAVOgvYsaCSOzPGy)
- The client must now create a DNS TXT record, named "_acme-challenge.\<domain\>" and add the validation token as the TXT record value. The client then tells the provider that it's ready. Ex.
  ```
  _acme-challenge.www.example.com    120  IN    TXT    4FirTtbveHPsRiDRxAVOgvYsaCSOzPGy
  ```
- The provider may take some time to perform its validation, so the client will periodically poll the provider for status. Once the provider is done and the status is good, the client will send a Certificate Signing Request (CSR) for the requested certificate.
- The provider will create the certificate and send the client a URL it can use to fetch it.
- The client fetches the new certificate and should now remove the DNS TXT record.

This is the general flow of ACMEv2 dns-01. Again, a more detailed and correct description is added below for reference. Once the client has access to the new certificate it may need to push that to the TLS service that actually needs it. The provisions for this step are specific to the TLS service.

<br />

-----

### Testing ACMEv2 DNS-01 in the All-in-One Lab Environment
The ACMEv2 all-in-one lab consists of a Docker Compose file that builds all of the necessary components to support a fully-contained, container-based environment. No external services are required. For DNS-01 testing specifically, you need an ACME client (NGINX), an ACME provider (Pebble or Smallstep), and a DNS server (Bind). During the proof phase of the protocol exchange, the client must be able to create a DNS TXT record, and subsequently remove it. In the lab, the ACME client is built with a set of scripts to work at the different phases:

<details>
  <summary>"Pre hook" script to add the DNS TXT record</summary>
  The CERTBOT_DOMAIN and CERTBOT_VALIDATION values are generated by the Certbot client and passed automatically to the hook script. These are the requested domain (ex. www.example.com) and the validation token, respectively. As this is a very simple Bind installation, SSH is used to echo the DNS TXT record to the zone file and then reload the zone.

  ```bash
  #!/bin/bash

  ## Only the top-level name of the domain is needed in the zone file
  domaintl=$(echo $$CERTBOT_DOMAIN | sed 's/.f5labs.local//')

  ## SSH echo the DNS TXT entry to the zone file
  sshpass -p 'bob' ssh -o StrictHostKeyChecking=no bob@10.10.0.53 "echo \"_acme-challenge.$${domaintl}  120 IN  TXT   ${CERTBOT_VALIDATION}\" >> /var/lib/bind/db.f5labs.local && rndc reload"

  ## Pause for 5 seconds
  sleep 5
  ```
</details>
<details>
  <summary>"Post hook" script to remove the DNS TXT record</summary>
  The post hook script is used to simply remove the DNS TXT record from the zone file after the proof validation is complete.
  
  ```bash
  #!/bin/bash

  ## SSH clean up the ephemeral zone entry
  sshpass -p 'bob' ssh -o StrictHostKeyChecking=no bob@10.10.0.53 'sed -i '/^_acme-challenge.*/d' /var/lib/bind/db.f5labs.local && rndc reload'
  ```
</details>
<details>
  <summary>"Deploy" script to move the certificate into place and reload the TLS server</summary>
  The simple TLS configuration on the NGINX server defines a location for the certificate. This script moves the renewed certificate to that location and reloads NGINX.

  ```bash
  #!/bin/bash

  ## Move the renewed certificate to the correct location for the NGINX config.
  cp -f /etc/letsencrypt/live/$${CERTBOT_DOMAIN}/* /etc/letsencrypt/live/f5labs.local/

  ## Reload the NGINX config
  nginx -s reload
  ```
</details>

<br />

**To test dns-01**:

1. Start the Docker Compose environment.
   ```bash
   docker compose up -d
   ```
3. Tail the NGINX container log until the logs settles.
   ```bash
   docker logs -f nginx
   ```
5. From your local system make an HTTPS request to the NGINX container, port 8443. On initial start this will use a "default" certificate.
   ```bash
   curl -vk https://(docker-host-ip):8443
   ```
3. Shell into the NGINX container.
   ```bash
   docker exec -it nginx /bin/bash
   ```
5. From the NGINX container, execute an ACME certificate renewal request to one of the ACME providers for a new certificate (ex. www.f5labs.local). The -vvv option on the command line will dump the entire ACME protocol exchange for your review. The below example uses the Pebble ACME server for the www.f5labs.local domain and specifies each of the hook scripts.
   ```bash
   server=https://pebble.acmelabs.local:14000/dir
   domain=www.f5labs.local
   certbot certonly --manual --no-eff-email --email admin@f5labs.local \
   -vvv --no-verify-ssl --agree-tos --preferred-challenges=dns --server ${server} \
   --domains ${domain} \
   --manual-auth-hook "/acme-hook-dns-pre.sh" \
   --manual-cleanup-hook "/acme-hook-dns-post.sh" \
   --deploy-hook "/acme-hook-deploy.sh"
   ```
7. From your local system make another HTTPS request to the NGINX container, port 8443. This should now be using the renewed certificate.
   ```bash
   curl -vk https://(docker-host-ip):8443
   ```
8. Optionally, shut down the Docker Compose. This will reset all configuration data.
   ```bash
   docker compose down
   ```


<br />

-----
### Detailed ACMEv2 DNS-01 Protocol Exchange

Data

<details>
  <summary>FOO</summary>
  
  ```
  DATA
  ```
</details>




